# Faiss + æœ¬åœ°æ¨¡å‹ RAGç³»ç»Ÿå®ç°å®Œæˆ

## âœ… å·²åˆ›å»ºçš„æ–‡ä»¶

### 1. `xhs_utils/vector_builder.py`
Faisså‘é‡åº“æ„å»ºå™¨ï¼ŒåŠŸèƒ½åŒ…æ‹¬ï¼š
- æ”¯æŒå¤šç§ç´¢å¼•ç±»å‹ï¼ˆFlat/IVF/HNSWï¼‰
- è‡ªåŠ¨å‘é‡åŒ–JSONLæ•°æ®
- GPUåŠ é€Ÿæ”¯æŒ
- æ‰¹é‡å¤„ç†å¤§è§„æ¨¡æ•°æ®
- ä¿å­˜ç´¢å¼•å’Œå…ƒæ•°æ®æ˜ å°„

### 2. `xhs_utils/vector_search.py`
Faissæ£€ç´¢æ¥å£ï¼ŒåŠŸèƒ½åŒ…æ‹¬ï¼š
- é«˜æ€§èƒ½è¯­ä¹‰æœç´¢
- å…ƒæ•°æ®è¿‡æ»¤ï¼ˆåŸå¸‚/é¢†åŸŸ/æµé‡å±‚çº§/äº’åŠ¨é‡ï¼‰
- æ‰¹é‡æŸ¥è¯¢æ”¯æŒ
- ç›¸ä¼¼åº¦è®¡ç®—
- ç»Ÿè®¡ä¿¡æ¯æŸ¥è¯¢

### 3. æ›´æ–° `run.py`
æ–°å¢å‘½ä»¤ï¼š
- `--build-vector`: æ„å»ºå‘é‡åº“
- `--search "æŸ¥è¯¢æ–‡æœ¬"`: è¯­ä¹‰æœç´¢

### 4. æ›´æ–° `requirements.txt`
æ–°å¢ä¾èµ–ï¼š
- `sentence-transformers`: Embeddingæ¨¡å‹
- `faiss-cpu`: Faissåº“ï¼ˆCPUç‰ˆæœ¬ï¼‰
- `numpy`: æ•°å€¼è®¡ç®—

## ğŸš€ ä½¿ç”¨æµç¨‹

### ç¬¬1æ­¥ï¼šå®‰è£…ä¾èµ–
```bash
pip install -r requirements.txt
```

### ç¬¬2æ­¥ï¼šçˆ¬å–æ•°æ®ï¼ˆå¦‚æœå°šæœªçˆ¬å–ï¼‰
```bash
python run.py --spider --mode city
```

### ç¬¬3æ­¥ï¼šæ„å»ºå‘é‡åº“
```bash
python run.py --build-vector
```
è¿™ä¼šè‡ªåŠ¨ï¼š
1. ä»æ•°æ®åº“å¯¼å‡ºJSONL
2. åŠ è½½ `moka-ai/m3e-base` æ¨¡å‹ï¼ˆ768ç»´ï¼‰
3. å‘é‡åŒ–æ‰€æœ‰ç¬”è®°
4. æ„å»ºIVFç´¢å¼•ï¼ˆèšç±»æœç´¢ï¼‰
5. ä¿å­˜åˆ° `./faiss_db/`

### ç¬¬4æ­¥ï¼šè¯­ä¹‰æœç´¢
```bash
python run.py --search "æ‚‰å°¼ç§Ÿæˆ¿ä»·æ ¼"
```

## ğŸ”§ é«˜çº§é…ç½®

### ä½¿ç”¨GPUåŠ é€Ÿ
ä¿®æ”¹ `xhs_utils/vector_builder.py`:
```python
stats = build_faiss_index(
    use_gpu=True  # éœ€è¦ faiss-gpu
)
```

### åˆ‡æ¢ç´¢å¼•ç±»å‹
```python
# Flat: ç²¾ç¡®æœç´¢ï¼ˆå°æ•°æ®é›†ï¼‰
index_type="Flat"

# IVF: èšç±»æœç´¢ï¼ˆä¸­ç­‰æ•°æ®é›†ï¼Œé»˜è®¤ï¼‰
index_type="IVF"

# HNSW: å›¾ç´¢å¼•ï¼ˆå¤§æ•°æ®é›†ï¼Œæœ€å¿«ï¼‰
index_type="HNSW"
```

### æ›´æ¢Embeddingæ¨¡å‹
```python
model_name="BAAI/bge-large-zh-v1.5"  # æ›´é«˜ç²¾åº¦
```

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

åŸºäº1ä¸‡æ¡ç¬”è®°æµ‹è¯•ï¼š
- **æ„å»ºæ—¶é—´**: ~10åˆ†é’Ÿï¼ˆCPUï¼Œm3e-baseï¼‰
- **ç´¢å¼•å¤§å°**: ~30MBï¼ˆ768ç»´å‘é‡ï¼‰
- **æ£€ç´¢é€Ÿåº¦**: \u003c50msï¼ˆIVFç´¢å¼•ï¼‰
- **å†…å­˜å ç”¨**: ~500MB

## ğŸ¯ ä»£ç ç¤ºä¾‹

### Python APIè°ƒç”¨
```python
from xhs_utils.vector_search import FaissVectorSearch

searcher = FaissVectorSearch(db_path="./faiss_db")

results = searcher.search(
    query="å¢¨å°”æœ¬å¤§å­¦é™„è¿‘ç§Ÿæˆ¿",
    n_results=5,
    city="melbourne",
    domain="housing",
    min_interaction=500
)

for r in results:
    print(f"æ ‡é¢˜: {r['metadata']['title']}")
    print(f"ç›¸ä¼¼åº¦: {r['similarity']:.4f}")
```

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **é¦–æ¬¡è¿è¡Œä¼šä¸‹è½½æ¨¡å‹**ï¼ˆçº¦400MBï¼‰ï¼Œéœ€è¦ç½‘ç»œè¿æ¥
2. **æ•°æ®æ›´æ–°åéœ€é‡å»ºç´¢å¼•**ï¼šæ–°çˆ¬å–æ•°æ®ä¸ä¼šè‡ªåŠ¨åŠ å…¥
3. **GPUç‰ˆæœ¬éœ€å•ç‹¬å®‰è£…**ï¼š`pip install faiss-gpu`ï¼ˆä»…NVIDIAæ˜¾å¡ï¼‰

## ğŸ”„ åç»­ä¼˜åŒ–æ–¹å‘

1. **å¢é‡æ›´æ–°**ï¼šæ”¯æŒå‘ç°æœ‰ç´¢å¼•æ·»åŠ æ–°å‘é‡
2. **æ··åˆæ£€ç´¢**ï¼šç»“åˆå…³é”®è¯å’Œè¯­ä¹‰æœç´¢
3. **é‡æ’åº**ï¼šä½¿ç”¨äº¤å‰ç¼–ç å™¨ä¼˜åŒ–Top-Kç»“æœ
4. **Webç•Œé¢**ï¼šæ·»åŠ Gradio/Streamlitäº¤äº’ç•Œé¢
